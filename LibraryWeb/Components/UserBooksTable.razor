@using DataModelLibrary.Models
@using MudBlazor

<MudTable T="Book" SortLabel="Sort by"
          @ref="_table"
          ServerData="ServerData"
          Hover="true"
          Dense="false"
          Loading="IsLoading"
          LoadingProgressColor="Color.Info"
          Elevation="0"
          OnRowClick="OnRowClick"
          RowClass="cursor-pointer">

    <ToolBarContent>
        <MudText Typo="Typo.h6">Books</MudText>
        <MudSpacer />

        <MudIconButton Icon="@Icons.Material.Filled.FilterList" Variant="Variant.Outlined" Color="Color.Primary" Class="mr-2" />

        <MudTextField Value="_searchString"
                      ValueChanged="@(EventCallback.Factory.Create<string>(this, OnSearchChangedInternal))"
                      Placeholder="Search"
                      Immediate="true"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      IconSize="Size.Medium"
                      Class="mt-0" />
    </ToolBarContent>

    <HeaderContent>
        <MudTh><MudTableSortLabel SortLabel="Title" SortBy="new Func<Book, object>(x => nameof(x.Title))">Title</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="Author" SortBy="new Func<Book, object>(x => x.Author)">Author</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="PublishedYear" SortBy="new Func<Book, object>(x => nameof(x.PublishedYear))">Published</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="Genre" SortBy="new Func<Book, object>(x => x.Genre.Name)">Genre</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="Price" SortBy="new Func<Book, object>(x => nameof(x.Price))">Price</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="QuantityInStock" SortBy="new Func<Book, object>(x => x.QuantityInStock)">Quantity</MudTableSortLabel></MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd DataLabel="Title">@context.Title</MudTd>
        <MudTd DataLabel="Author">@context.Author</MudTd>
        <MudTd DataLabel="Published">@context.PublishedYear</MudTd>
        <MudTd DataLabel="Genre">@context.Genre.Name</MudTd>
        <MudTd DataLabel="Price">@context.Price</MudTd>
        <MudTd DataLabel="Quantity">@context.QuantityInStock</MudTd>
    </RowTemplate>

    <PagerContent>
        <MudTablePager PageSizeOptions="_pageSizeOptions" />
    </PagerContent>

    <NoRecordsContent>
        <MudText>No books found.</MudText>
    </NoRecordsContent>

</MudTable>

@code {

    [Parameter, EditorRequired]
    public Func<TableState, CancellationToken,Task<TableData<Book>>> ServerData { get; set; } = default!;

    [Parameter]
    public bool IsLoading { get; set; }

    [Parameter]
    public EventCallback<TableRowClickEventArgs<Book>> OnRowClick { get; set; }

    [Parameter]
    public EventCallback<string> OnSearchChanged { get; set; }

    private MudTable<Book>? _table;
    private string _searchString = "";
    private readonly int[] _pageSizeOptions = { 5, 10, 20, 50 };

    private async Task OnSearchChangedInternal(string value)
    {
        _searchString = value;

        if (OnSearchChanged.HasDelegate)
            await OnSearchChanged.InvokeAsync(value);

        await _table!.ReloadServerData();
    }
}
